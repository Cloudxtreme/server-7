#!/bin/bash
#set -x

stop_server() {
   /bin/bash /home/minecraft/init/minecraft stop
}

trap 'stop_server' SIGTERM SIGKILL

chown -R minecraft:minecraft /home/minecraft/server

# Check first run
if [[ ! $(ls -A /home/minecraft/server/config-server) ]]; then
    /bin/bash /home/minecraft/init/minecraft start

    while [[ ! -f /home/minecraft/server/bukkit.yml ]] || [[ ! -f /home/minecraft/server/spigot.yml ]] || [[ ! -f /home/minecraft/server/cauldron.yml ]] || [[ ! -f /home/minecraft/server/kcauldron.yml ]] || [[ ! -f /home/minecraft/server/server.properties ]]
    do
        sleep 3
    done

    echo "Wait until world will be ready..."
    sleep 30 # Wait world generation

    /bin/bash /home/minecraft/init/minecraft stop
    while /bin/bash /home/minecraft/init/minecraft status > /dev/null
    do
        sleep 3
    done

    mv /home/minecraft/server/bukkit.yml /home/minecraft/server/config-server/bukkit.yml
    mv /home/minecraft/server/spigot.yml /home/minecraft/server/config-server/spigot.yml
    mv /home/minecraft/server/cauldron.yml /home/minecraft/server/config-server/cauldron.yml
    mv /home/minecraft/server/server.properties /home/minecraft/server/config-server/server.properties
    mv /home/minecraft/server/kcauldron.yml /home/minecraft/server/config-server/kcauldron.yml
    mv /home/minecraft/server/banned-players.json /home/minecraft/server/config-server/banned-players.json
    mv /home/minecraft/server/banned-ips.json /home/minecraft/server/config-server/banned-ips.json
    mv /home/minecraft/server/ops.json /home/minecraft/server/config-server/ops.json
    mv /home/minecraft/server/whitelist.json /home/minecraft/server/config-server/whitelist.json
fi

ln -s /home/minecraft/server/config-server/spigot.yml /home/minecraft/server/spigot.yml
ln -s /home/minecraft/server/config-server/bukkit.yml /home/minecraft/server/bukkit.yml
ln -s /home/minecraft/server/config-server/cauldron.yml /home/minecraft/server/cauldron.yml
ln -s /home/minecraft/server/config-server/server.properties /home/minecraft/server/server.properties
ln -s /home/minecraft/server/config-server/kcauldron.yml /home/minecraft/server/kcauldron.yml
ln -s /home/minecraft/server/config-server/banned-players.json /home/minecraft/server/banned-players.json
ln -s /home/minecraft/server/config-server/banned-ips.json /home/minecraft/server/banned-ips.json
ln -s /home/minecraft/server/config-server/ops.json /home/minecraft/server/ops.json
ln -s /home/minecraft/server/config-server/whitelist.json /home/minecraft/server/whitelist.json

LVLNAME=$(cat /home/minecraft/server/config-server/server.properties | grep level-name | awk '{split($0,a,"="); print a[2]}')

[[ -z ${LVLNAME} ]] && echo "Level name is empty!" && exit 1

if [[ -d /home/minecraft/server/worlds/${LVLNAME} ]]; then
    [[ -d /home/minecraft/server/${LVLNAME} ]] && rm -rf /home/minecraft/server/${LVLNAME}
else
    [[ -d /home/minecraft/server/${LVLNAME} ]] && mv /home/minecraft/server/${LVLNAME} /home/minecraft/server/worlds/${LVLNAME}
fi

ln -s /home/minecraft/server/worlds/${LVLNAME} /home/minecraft/server/${LVLNAME}

/bin/bash /home/minecraft/init/minecraft start

while /bin/bash /home/minecraft/init/minecraft status > /dev/null
do
    sleep 15
done
